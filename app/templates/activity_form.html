{% extends "base.html" %}

{% block title %}{{ title }} - CoachManager{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">{{ title }}</h1>
    <p class="text-slate-600 dark:text-slate-400 mb-6">Trainingsplan: {{ plan.title }}</p>
    
    <form method="POST" class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-6" id="activity-form">
        {{ form.hidden_tag() }}
        
        <div>
            <label class="block text-sm font-medium mb-2">{{ form.activity_name.label }} *</label>
            {{ form.activity_name(class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700") }}
            {% if form.activity_name.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.activity_name.errors[0] }}</p>
            {% endif %}
            <p class="mt-1 text-xs text-slate-500 dark:text-slate-400" id="activity-name-hint">
                Für Team-Wide, Prepractice und Special Teams
            </p>
        </div>
        
        <div>
            <label class="block text-sm font-medium mb-2">{{ form.activity_type.label }} *</label>
            {{ form.activity_type(class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700") }}
            {% if form.activity_type.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.activity_type.errors[0] }}</p>
            {% endif %}
            <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                Prepractice: Rückwärts vom Trainingsstart berechnet<br>
                Team-Wide: Für das gesamte Team<br>
                Group-Specific: Für Positionsgruppen (können zusammengelegt werden)<br>
                Special Teams: Für Special Teams Training
            </p>
        </div>
        
        <div>
            <label class="block text-sm font-medium mb-2">{{ form.duration_minutes.label }} *</label>
            {{ form.duration_minutes(class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700") }}
            {% if form.duration_minutes.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.duration_minutes.errors[0] }}</p>
            {% endif %}
        </div>
        
        <!-- Group-Specific: Gruppenauswahl und Kombinationen -->
        <div id="groups-section" style="display: none;">
            <label class="block text-sm font-medium mb-2">Positionsgruppen auswählen</label>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <label class="flex items-center">
                    {{ form.group_OL(class="mr-2 group-checkbox") }}
                    <span>OL</span>
                </label>
                <label class="flex items-center">
                    {{ form.group_DL(class="mr-2 group-checkbox") }}
                    <span>DL</span>
                </label>
                <label class="flex items-center">
                    {{ form.group_LB(class="mr-2 group-checkbox") }}
                    <span>LB</span>
                </label>
                <label class="flex items-center">
                    {{ form.group_RB(class="mr-2 group-checkbox") }}
                    <span>RB</span>
                </label>
                <label class="flex items-center">
                    {{ form.group_TE(class="mr-2 group-checkbox") }}
                    <span>TE</span>
                </label>
                <label class="flex items-center">
                    {{ form.group_WR(class="mr-2 group-checkbox") }}
                    <span>WR</span>
                </label>
                <label class="flex items-center">
                    {{ form.group_QB(class="mr-2 group-checkbox") }}
                    <span>QB</span>
                </label>
                <label class="flex items-center">
                    {{ form.group_DB(class="mr-2 group-checkbox") }}
                    <span>DB</span>
                </label>
            </div>
            
            <div id="group-combinations" class="space-y-3">
                <p class="text-sm font-medium mb-2">Gruppenkombinationen erstellen:</p>
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                    Wähle Gruppen aus und erstelle Kombinationen. Für jede Kombination kannst du einen eigenen Aktivitätsnamen eingeben.
                </p>
                <div id="combinations-list"></div>
                <button type="button" id="add-combination-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 rounded-lg text-sm">
                    + Neue Kombination hinzufügen
                </button>
            </div>
        </div>
        
        <div>
            <label class="block text-sm font-medium mb-2">{{ form.notes.label }}</label>
            {{ form.notes(class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700", rows=3) }}
            {% if form.notes.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.notes.errors[0] }}</p>
            {% endif %}
        </div>
        
        <div class="flex gap-4">
            <button type="submit" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium">
                Speichern
            </button>
            <a href="{{ url_for('routes.training_plan_detail', id=plan.id) }}" 
               class="px-6 py-2 bg-slate-300 dark:bg-slate-700 hover:bg-slate-400 dark:hover:bg-slate-600 text-slate-900 dark:text-slate-50 rounded-lg font-medium">
                Abbrechen
            </a>
        </div>
    </form>
</div>

<script>
const GROUPS = ['OL', 'DL', 'LB', 'RB', 'TE', 'WR', 'QB', 'DB'];
let combinationCounter = 0;
let groupCombinations = {};

// Initialisiere Gruppenkombinationen aus bestehender Aktivität (falls vorhanden)
{% if activity and activity.activity_type == 'group_specific' and activity.group_activities %}
    groupCombinations = {{ activity.group_activities | tojson }};
    combinationCounter = Object.keys(groupCombinations).length;
{% endif %}

document.addEventListener('DOMContentLoaded', function() {
    const activityTypeSelect = document.querySelector('select[name="activity_type"]');
    const groupsSection = document.getElementById('groups-section');
    const activityNameField = document.querySelector('input[name="activity_name"]');
    const activityNameHint = document.getElementById('activity-name-hint');
    const addCombinationBtn = document.getElementById('add-combination-btn');
    const combinationsList = document.getElementById('combinations-list');
    
    function toggleGroups() {
        if (activityTypeSelect.value === 'group_specific') {
            groupsSection.style.display = 'block';
            activityNameField.required = false;
            activityNameHint.textContent = 'Für Group-Specific: Aktivitätsnamen werden pro Gruppenkombination eingegeben';
            renderCombinations();
        } else {
            groupsSection.style.display = 'none';
            activityNameField.required = true;
            activityNameHint.textContent = 'Für Team-Wide, Prepractice und Special Teams';
            combinationsList.innerHTML = '';
        }
    }
    
    function getSelectedGroups() {
        const selected = [];
        GROUPS.forEach(group => {
            const checkbox = document.querySelector(`input[name="group_${group}"]`);
            if (checkbox && checkbox.checked) {
                selected.push(group);
            }
        });
        return selected;
    }
    
    function createCombinationInput(combinationKey, activityName = '') {
        const groups = combinationKey.split(',');
        const div = document.createElement('div');
        div.className = 'bg-slate-50 dark:bg-slate-900 p-4 rounded-lg border border-slate-200 dark:border-slate-700';
        div.dataset.combinationKey = combinationKey;
        
        const groupsDisplay = groups.map(g => `<span class="px-2 py-1 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded text-xs mr-1">${g}</span>`).join('');
        
        div.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium">Gruppen:</span>
                    ${groupsDisplay}
                </div>
                <button type="button" class="remove-combination text-red-600 hover:text-red-700 text-sm" data-key="${combinationKey}">
                    ✕ Entfernen
                </button>
            </div>
            <input type="text" 
                   name="group_activity_${combinationKey}" 
                   value="${activityName}"
                   placeholder="z.B. OL/DL ST Line oder LB & RB"
                   class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700"
                   required>
        `;
        
        div.querySelector('.remove-combination').addEventListener('click', function() {
            delete groupCombinations[combinationKey];
            div.remove();
            updateHiddenFields();
        });
        
        return div;
    }
    
    function renderCombinations() {
        combinationsList.innerHTML = '';
        
        // Erstelle Kombinationen aus bestehenden Daten
        Object.keys(groupCombinations).forEach(key => {
            const div = createCombinationInput(key, groupCombinations[key]);
            combinationsList.appendChild(div);
        });
        
        // Wenn keine Kombinationen vorhanden, erstelle eine Standard-Kombination aus ausgewählten Gruppen
        if (Object.keys(groupCombinations).length === 0) {
            const selected = getSelectedGroups();
            if (selected.length > 0) {
                const key = selected.join(',');
                groupCombinations[key] = '';
                const div = createCombinationInput(key, '');
                combinationsList.appendChild(div);
            }
        }
        
        updateHiddenFields();
    }
    
    function updateHiddenFields() {
        // Entferne alte hidden fields
        document.querySelectorAll('input[name^="group_activity_"]').forEach(input => {
            if (input.type === 'hidden') input.remove();
        });
        
        // Erstelle hidden fields für jede Kombination
        Object.keys(groupCombinations).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `group_activity_${key}`;
            input.value = groupCombinations[key] || '';
            document.getElementById('activity-form').appendChild(input);
        });
    }
    
    addCombinationBtn.addEventListener('click', function() {
        const selected = getSelectedGroups();
        if (selected.length === 0) {
            alert('Bitte wähle zuerst mindestens eine Gruppe aus.');
            return;
        }
        
        // Prüfe, ob diese Kombination bereits existiert
        const key = selected.join(',');
        if (groupCombinations[key]) {
            alert('Diese Kombination existiert bereits.');
            return;
        }
        
        groupCombinations[key] = '';
        const div = createCombinationInput(key, '');
        combinationsList.appendChild(div);
        updateHiddenFields();
    });
    
    // Aktualisiere Kombinationen, wenn Gruppen-Checkboxen geändert werden
    document.querySelectorAll('.group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (activityTypeSelect.value === 'group_specific') {
                // Prüfe, ob alle Kombinationen noch gültig sind
                const selected = getSelectedGroups();
                Object.keys(groupCombinations).forEach(key => {
                    const groups = key.split(',');
                    const allSelected = groups.every(g => selected.includes(g));
                    if (!allSelected) {
                        delete groupCombinations[key];
                        const div = document.querySelector(`[data-combination-key="${key}"]`);
                        if (div) div.remove();
                    }
                });
                renderCombinations();
            }
        });
    });
    
    // Aktualisiere groupCombinations aus Input-Feldern beim Submit
    document.getElementById('activity-form').addEventListener('submit', function() {
        document.querySelectorAll('input[name^="group_activity_"]').forEach(input => {
            if (input.type === 'text') {
                const key = input.name.replace('group_activity_', '');
                groupCombinations[key] = input.value;
            }
        });
        updateHiddenFields();
    });
    
    if (activityTypeSelect) {
        activityTypeSelect.addEventListener('change', toggleGroups);
        toggleGroups(); // Initial aufrufen
    }
    
    // Initialisiere Kombinationen aus bestehender Aktivität
    {% if activity and activity.activity_type == 'group_specific' and activity.group_activities %}
        renderCombinations();
    {% endif %}
});
</script>
{% endblock %}
